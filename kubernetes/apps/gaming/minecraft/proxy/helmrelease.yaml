---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: minecraft-proxy
  namespace: gaming
spec:
  interval: 30m
  timeout: 15m
  chart:
    spec:
      chart: minecraft-proxy
      version: 3.5.0
      sourceRef:
        kind: HelmRepository
        name: itzg-charts
        namespace: flux-system

  values:
    deploymentAnnotations:
      reloader.stakater.com/auto: "true"
    image:
      repository: itzg/bungeecord
      tag: 2023.11.0
    resources:
      requests:
        cpu: 50m
      limits:
        memory: 1Gi
    podSecurityContext:
      runAsUser: "${APP_UID}"
      fsGroup: "${APP_GID}"
    livenessProbe:
      enabled: false
    readinessProbe:
      enabled: false
    startupProbe:
      enabled: false
    extraEnv:
      TZ: "${TIMEZONE}"
      SPIGET_PLUGINS: "78915,75"
    persistence:
      dataDir:
        enabled: true
        existingClaim: "${VOLSYNC_CLAIM}"
    serviceAnnotations:
      io.cilium/lb-ipam-ips: "${MINECRAFT_LB_IP}"
      mc-router.itzg.me/externalServerName: "minecraft.${PRIVATE_DOMAIN}"
    minecraftProxy:
      type: WATERFALL
      # A list of .jar URLs to download into the plugins folder.
      # plugins: []
      serviceType: LoadBalancer
      loadBalancerIP: ${MINECRAFT_LB_IP}
      externalTrafficPolicy: Local
      # externalIPs:
      # This can be set to the contents of your config file (only works with yaml currently)
      config: |
        player_limit: -1
        ip_forward: true
        permissions:
          default:
          - bungeecord.command.server
          - bungeecord.command.list
          - alert.trigger
          - slashserver.lobby
          admin:
          - bungeecord.command.alert
          - bungeecord.command.end
          - bungeecord.command.ip
          - bungeecord.command.reload
          - alert.receive
          - alert.receive.firstjoin
          - alert.command.toggle
          - alert.command.reload
          family:
          - bungeecord.server.cobblemon
        timeout: 30000
        log_pings: true
        log_commands: false
        online_mode: true
        servers:
          lobby:
            motd: 'Lobby'
            address: minecraft-lobby-minecraft:25565
            restricted: false
          cobblemon:
            motd: 'Cobblemon'
            address: minecraft-cobblemon-minecraft:25565
            restricted: false
          survival2:
            motd: 'Pixelmon'
            address: minecraft-pixelmon-minecraft:25565
            restricted: false
        listeners:
        - query_port: 25577
          motd: 'Lobby'
          priorities:
          - lobby
          bind_local_address: true
          tab_list: GLOBAL_PING
          query_enabled: true
          host: 0.0.0.0:25577
        ping_passthrough: true
        groups:
          Spiceratops:
          - admin
          - family
          Binggak:
          - family
