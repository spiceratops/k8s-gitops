---
clusterName: &cluster k8s

clusterPodNets:
  - 10.244.0.0/16
clusterSvcNets:
  - 10.245.0.0/16

talosVersion: v1.5.3
kubernetesVersion: v1.28.2
endpoint: https://k8s.${domainName}:6443

additionalApiServerCertSans:
  - ${clusterEndpointIP}

additionalMachineCertSans:
  - ${clusterEndpointIP}
  - k8s.${domainName}

cniConfig:
  name: none

nodes:
  - hostname: k8s-cp01.${domainName}
    ipAddress: 192.168.10.201
    installDisk: /dev/sda
    controlPlane: true
    disableSearchDomain: true
    nameservers:
      - 192.168.10.1
    networkInterfaces:
      - interface: eth0
        dhcp: true
    nodeLabels:
      topology.kubernetes.io/region: k8s
      topology.kubernetes.io/zone: cp

  - hostname: k8s-cp02.${domainName}
    ipAddress: 192.168.10.202
    installDisk: /dev/sda
    controlPlane: true
    disableSearchDomain: true
    nameservers:
      - 192.168.10.1
    networkInterfaces:
      - interface: eth0
        dhcp: true
    nodeLabels:
      topology.kubernetes.io/region: k8s
      topology.kubernetes.io/zone: cp

  - hostname: k8s-cp03.${domainName}
    ipAddress: 192.168.10.203
    installDisk: /dev/sda
    controlPlane: true
    disableSearchDomain: true
    nameservers:
      - 192.168.10.1
    networkInterfaces:
      - interface: eth0
        dhcp: true
    nodeLabels:
      topology.kubernetes.io/region: k8s
      topology.kubernetes.io/zone: cp

  - hostname: k8s-wk01.${domainName}
    ipAddress: 192.168.10.211
    installDisk: /dev/sda
    controlPlane: false
    disableSearchDomain: true
    nameservers:
      - 192.168.10.1
    networkInterfaces:
      - interface: eth0
        dhcp: true
    nodeLabels:
      node-role.kubernetes.io/worker: worker
      topology.kubernetes.io/region: k8s
      topology.kubernetes.io/zone: wk

  - hostname: k8s-wk02.${domainName}
    ipAddress: 192.168.10.212
    installDisk: /dev/sda
    controlPlane: false
    disableSearchDomain: true
    nameservers:
      - 192.168.10.1
    networkInterfaces:
      - interface: eth0
        dhcp: true
    nodeLabels:
      node-role.kubernetes.io/worker: worker
      topology.kubernetes.io/region: k8s
      topology.kubernetes.io/zone: wk

  - hostname: k8s-wk03.${domainName}
    ipAddress: 192.168.10.213
    installDisk: /dev/sda
    controlPlane: false
    disableSearchDomain: true
    nameservers:
      - 192.168.10.1
    networkInterfaces:
      - interface: eth0
        dhcp: true
    nodeLabels:
      node-role.kubernetes.io/worker: worker
      topology.kubernetes.io/region: k8s
      topology.kubernetes.io/zone: wk

controlPlane:
  inlinePatch:
    cluster:
      allowSchedulingOnMasters: true
      proxy:
        disabled: true
      etcd:
        extraArgs:
          listen-metrics-urls: http://0.0.0.0:2381
      controllerManager:
        extraArgs:
          bind-address: 0.0.0.0
      scheduler:
        extraArgs:
          bind-address: 0.0.0.0
      apiServer:
        admissionControl: null
      discovery:
        registries:
          service:
            disabled: true
    machine: &machine
      install:
        image: ghcr.io/siderolabs/installer:v1.5.3
        extensions:
          - image: ghcr.io/siderolabs/intel-ucode:20230808
          - image: ghcr.io/siderolabs/i915-ucode:20230804
          - image: ghcr.io/siderolabs/qemu-guest-agent:8.1.0
          # - image: ghcr.io/siderolabs/tailscale:1.44.0
        extraKernelArgs:
          - talos.logging.kernel=udp://vector.${domainName}:6001/
      features:
        kubePrism:
          enabled: true
          port: 7445
      logging:
        destinations:
          - endpoint: udp://vector.${domainName}:6002/
            format: json_lines
      sysctls:
        fs.inotify.max_user_watches: 1048576
        fs.inotify.max_user_instances: 8192
      network:
        extraHostEntries:
          - ip: ${clusterEndpointIP}
            aliases:
              - k8s.${domainName}
          - ip: 192.168.15.4
            aliases:
              - vector.${domainName}
          - ip: 192.168.10.10
            aliases:
              - nas.${domainName}
          - ip: 192.168.10.10
            aliases:
              - s3.${domainName}
          - ip: 192.168.10.1
            aliases:
              - opnsense.${domainName}
          - ip: 192.168.1.107
            aliases:
              - home.${domainName}
          - ip: 192.168.1.252
            aliases:
              - pve.${domainName}
          - ip: 192.168.1.241
            aliases:
              - pve-hass.${domainName}
      time:
        disabled: false
        servers:
          - 192.168.1.1
      kubelet:
        extraArgs:
          feature-gates: GracefulNodeShutdown=true
          rotate-server-certificates: true
      files:
        - content: |
            [plugins."io.containerd.grpc.v1.cri"]
              enable_unprivileged_ports = true
              enable_unprivileged_icmp = true
          path: /var/cri/conf.d/allow-unpriv-ports.toml
          op: create
        # - content: |
        #     TS_AUTHKEY=${TS_AUTHKEY}
        #     PORT: 41642
        #     TS_KUBE_SECRET: tailscale-state
        #     SA_NAME: tailscale
        #     TS_USERSPACE: true
        #     TS_ROUTES: |-
        #       192.168.15.0/24,10.245.0.0/16
        #   permissions: 0644
        #   path: /var/etc/tailscale/auth.env
        #   op: create

worker:
  inlinePatch:
    machine:
      <<: *machine
