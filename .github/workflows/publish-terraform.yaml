---
  name: Publish Terraform

  on:
    workflow_dispatch:
    push:
      branches: ["main"]
      paths: ["terraform/**"]

  env:
    TERRAFORM_DIR: ./terraform

  jobs:
    publish-terraform:
      name: Publish Terraform
      runs-on: ubuntu-latest
      permissions:
        contents: read
        packages: write
      steps:
        - name: Generate Token
          uses: actions/create-github-app-token@def152b8a737443d7af6c5722c6389146fe90c90 # v2.1.2
          id: app-token
          with:
            app-id: "${{ secrets.BOT_APP_ID }}"
            private-key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"

        - name: Setup Path
          run: echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH

        - name: Setup Workflow Tools
          run: brew update && brew install fluxcd/tap/flux

        - name: Checkout
          uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
          with:
            token: "${{ steps.app-token.outputs.token }}"

        - name: Login to GitHub Container Registry
          uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
          with:
            registry: ghcr.io
            username: "${{ github.actor }}"
            password: "${{ secrets.GITHUB_TOKEN }}"
            # https://github.com/orgs/community/discussions/24636
            # username: "${{ secrets.BOT_APP_ID }}"
            # password: "${{ steps.app-token.outputs.token }}"

        - name: Generate Tag
          id: generate-tag
          shell: bash
          run: echo "tag=ghcr.io/${{ github.repository_owner }}/manifests/terraform:$(git rev-parse --short HEAD)" >> "${GITHUB_OUTPUT}"

        - name: Publish OCI Artifacts
          shell: bash
          run: |
            flux push artifact oci://${{ steps.generate-tag.outputs.tag }} \
                --path="${{ env.TERRAFORM_DIR }}" \
                --source="$(git config --get remote.origin.url)" \
                --revision="$(git branch --show-current)/$(git rev-parse HEAD)"

        - name: Tag OCI Artifact
          shell: bash
          run: flux tag artifact oci://${{ steps.generate-tag.outputs.tag }} --tag master
